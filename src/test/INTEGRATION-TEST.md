## Integration Tests: WSO2 EI Google Firebase Connector.

### Pre-requisites:

    - Maven 3.x
    - Java 1.8 or above
    - The org.wso2.esb.integration.integration-base project is required. The test suite has been configured to download this project automatically. If the automatic download fails, download the following project and compile it using the mvn clean install command to update your local repository:
      https://github.com/wso2-extensions/esb-integration-base

### Tested Platforms:

    - Ubuntu 16.04
    - WSO2 EI 6.5.0
    - java 1.8


### Steps to follow in setting integration test.


 1. Download EI 6.5.0  by navigating to the following [URL](http://wso2.com/products/enterprise-service-bus/#).
 2. Unzip the EI pack.
 3. Download following jars [firebase-admin-6.5.0.jar](https://mvnrepository.com/artifact/com.google.firebase/firebase-admin/6.5.0), [google-auth-library-credentials-0.11.0.jar](https://mvnrepository.com/artifact/com.google.auth/google-auth-library-credentials/0.11.0), [google-auth-library-oauth2-http-0.11.0.jar](https://mvnrepository.com/artifact/com.google.auth/google-auth-library-oauth2-http/0.11.0), [api-common-1.7.0.jar](https://mvnrepository.com/artifact/com.google.api/api-common/1.7.0), place those into <EI_HOME>/lib folder and compress the EI pack.
 4. Place the updated EI 6.4.0 zip to the location `Connector_Home/repository/`
 5. Follow the steps below to get your service account's credentials from Google firebase console :

    * If you don't already have a Firebase project, add one in the [Firebase console](https://console.firebase.google.com).
    * The **Add project** dialog also gives you the option to add Firebase to an existing Google Cloud Platform project.
    * Navigate to the [Service Accounts](https://console.firebase.google.com/project/_/settings/serviceaccounts/adminsdk) tab in your project's settings page.
    * Click the **Generate New Private Key** button at the bottom of the **Firebase Admin SDK** section of the **Service Accounts** tab.

    After you click the button, a JSON file containing your service account's credentials will be downloaded. You'll need this to initialize the firebase connector init operation in the next step.

 6. Update the following properties in `esb-connector-googlefirebase.properties` file at `Connector_Home/repository/`

    * accountType: Obtain the "type" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * projectId: Obtain the "project_id" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * privateKeyId: Obtain the "private_key_id" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * privateKey: Obtain the "private_key" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * clientEmail: Obtain the "client_email" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * clientId: Obtain the "client_id" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * authUri: Obtain the "auth_uri" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * tokenUri: Obtain the "token_uri" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * authProviderCertUrl: Obtain the "auth_provider_x509_cert_url" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * clientCertUrl: Obtain the "client_x509_cert_url" parameter value from the service account's credentials JSON file that you obtain in the previous step.
    * messagingType: It must be one of the "token" or "topic" or "condition"
    * registrationToken: If you specify "messagingType" as token, you must provide this value. FCM API allows you to send messages to individual devices by specifying a registration token for the target device. Registration tokens are strings generated by the client FCM SDKs for each end-user client app instance(Refer https://github.com/firebase/quickstart-android/blob/master/messaging/README.md for more information.).
    * topicName: If you specify "messagingType" as topic, you must provide this value. Name of the topic. Based on the publish/subscribe model,
                 FCM topic messaging allows you to send a message to multiple devices that have opted in to a particular topic.
                 You compose topic messages as needed, and FCM handles routing and delivering the message reliably to the right devices.
    * condition: If you specify "messagingType" as condition, you must provide this value. And if you want to send a message to a
                 combination of topics. This is done by specifying a condition, which is a boolean expression that specifies the target topics.
    * tokenList: List of registration tokens as comma separated values which are generated by the client FCM SDKs for each end-user client app instance.
    * restrictedPackageName: Package name of the application where the registration tokens must match in order to receive the message.

 7. Update the googlefirebase properties file at location `<Connector_Home>/src/test/resources/artifacts/ESB/connector/config` as below.


    | Property | Description |
    | ------------- |-------------|
    | dryRunMode | It is used to send FCM messages in the dry run mode. It performs all the usual validations on the messages sent in this mode, but they are not actually delivered to the target devices. |
    | dataFieldsOfMessage | It defines key-value pair to the message as a data field. Eg: "key1:value1,key2:value2" |
    | notificationTitle | Sets the notification information (notification title) to be included in the message. |
    | notificationBody | Sets the notification information (notification body) to be included in the message |
    | androidPriority | Message priority. Must be one of "normal" and "high" values. |
    | timeToLiveDuration | The time-to-live duration of the message. This is how long the message will be kept in FCM storage if the target devices are offline. Maximum allowed is 4 weeks, which is also the default. Set to 0 to send the message immediately (fire and forget). |
    | collapseKey | An identifier of a group of messages that can be collapsed, so that only the last message gets sent when delivery can be resumed. A maximum of 4 different collapse keys is allowed at any given time. |
    | dataFieldsOfAndroidConfig | A map of key-value pairs where each key and value are strings. If specified, overrides the data field set on the "dataFieldsOfMessage" property (top-level message). Eg: "key1:value1, key2:value2" |
    | androidNotificationTitle | Sets notification title that is specific to Android notifications. |
    | androidNotificationBody | Sets notification body that is specific to Android notifications. |
    | androidClickAction | Sets the action associated with a user click on the notification. If specified, an activity with a matching Intent Filter is launched when a user clicks on the notification. |
    | androidIcon | The notification icon. If not specified, FCM displays the launcher icon specified in your app manifest. |
    | androidColor | The notification's icon color, expressed in #rrggbb format. |
    | androidTag | Identifier used to replace existing notifications in the notification drawer. If not specified, each request creates a new notification. If specified and a notification with the same tag is already being shown, the new notification replaces the existing one in the notification drawer. |
    | androidSound | The sound to play when the device receives the notification. Supports default or the filename of a sound resource bundled in the app. |
    | androidTitleLocalizationKey | The key of the title string in the app's string resources to use to localize the title text to the user's current localization. |
    | androidBodyLocalizationKey | The key of the body string in the app's string resources to use to localize the body text to the user's current localization. |
    | androidTitleLocalizationArgs | A list of string values to be used in place of the format specifiers in "androidTitleLocalizationKey" to use to localize the title text to the user's current localization. |
    | androidBodyLocalizationArgs | A list of string values to be used in place of the format specifiers in "androidBodyLocalizationKey" to use to localize the body text to the user's current localization. |
    | apnsHeaders | HTTP request headers defined in Apple Push Notification Service. Refer to [APNS request headers](https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingwithAPNs.html) for supported headers. Eg: "header1:value1, header2:value2" |
    | apnsCustomData | A map of key-value pairs where each key and value are strings. If specified, overrides the data field set on the "dataFieldsOfMessage" (top-level message). Eg: "key1:value1, key2:value2" |
    | apnsBadge | Include this key when you want the system to modify the badge of your app icon. If this key is not included in the dictionary, the badge is not changed. To remove the badge, set the value of this key to 0. |
    | apnsSound | Include this key when you want the system to play a sound. The value of this key is the name of a sound file. |
    | apnsContentAvailable | Include this key with a value of 1 to configure a background update notification. When this key is present, the system wakes up your app in the background and delivers the notification to its app delegate. |
    | apnsCategory | Provide this key with a string value that represents the notificationâ€™s type. |
    | apnsThreadId | Provide this key with a string value that represents the app-specific identifier for grouping notifications. |
    | apnsAlertTitle | Include this key when you want the system to display a standard alert. A short string describing the purpose of the notification. |
    | apnsAlertBody | Include this key when you want the system to display a standard alert. The text of the alert message. |
    | webPushHeaders | Adds the given key-value pair as a Webpush HTTP header. Refer to [WebPush specification](https://tools.ietf.org/html/rfc8030#section-5) for supported headers. Eg:"header1:value1,header2:value2" |
    | webPushData | A map of key-value pairs where each key and value are strings. If specified, overrides the data field set on the "dataFieldsOfMessage" (top-level message). Eg: "key1:value1, key2:value2" |
    | webPushNotificationTitle | The title of the notification. This title overrides the corresponding field on the "notificationTitle" (top-level message notification). |
    | webPushNotificationBody | The body of the notification. This body overrides the corresponding field on the "notificationBody" (top-level message notification). |
    | webPushNotificationIcon | It contains the URL of an icon to be displayed as part of the web notification. |
    | webPushNotificationBadge | The URL of the image used to represent the notification when there is not enough space to display the notification itself. |
    | webPushNotificationImage | The URL of an image to be displayed as part of the notification. |
    | webPushNotificationLanguage | Sets the language of the notification. |
    | webPushNotificationTag | Sets an identifying tag on the notification. The idea of notification tags is that more than one notification can share the same tag, linking them together. One notification can then be programmatically replaced with another to avoid the users' screen being filled up with a huge number of similar notifications. |
    | webPushNotificationDirection | The text direction of the notification. |
    | webPushNotificationRenotify | Specifies whether the user should be notified after a new notification replaces an old one. |
    | webPushNotificationInteraction | A Boolean indicating that a notification should remain active until the user clicks or dismisses it, rather than closing automatically. |
    | webPushNotificationSilent | Specifies whether the notification should be silent. i.e., no sounds or vibrations should be issued, regardless of the device settings. |
    | webPushNotificationTimestamp | Specifies the time at which a notification is created or applicable. |
    | webPushNotificationVibrate | Specifies a vibration pattern for devices with vibration hardware to emit |

8.  Navigate to `{EI_Connector_Home}/` and run the following command.
             `$ mvn clean install -Dskip-tests=false`